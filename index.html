<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Procon 2021</title>
    <style>
        form>* {
            display: block;
            margin: 5px;
        }

        .result>* {
            display: block;
            margin: 5px;
        }
    </style>
</head>

<body>
    <form id="action-form">
        <label for="token">token</label>
        <input type="text" name="token" id="token">
        <label for="token">Test_case:</label>
        <input type="number" name="Test_case" id="Test_case">
        <label for="matchID">matchID</label>
        <button>submit</button>
    </form>
    <div id="image">

    </div>

    <script>
        let token, tc = 0;
        let reload = false;
        const url = 'http://112.137.129.202:8006/';
        const form = document.getElementById("action-form")
        form.addEventListener("submit", (e) => {
            e.preventDefault()
            token = document.getElementById("token").value.trim()
            tc = document.getElementById("Test_case").value;
            console.log(tc);

            fetch(url + `tournament/`, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json",
                },
            })
                .then(response => response.json())
                .then(data => { getRound(data[0].id); });

        })

        function getRound(tournamentID) {
            fetch(url + `tournament/` + tournamentID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => { getMatch(data.Rounds[0].id) });
        }

        function getMatch(roundID) {
            fetch(url + `round/` + roundID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => {
                    // getChallenge(data.Matches[tc].id_challenge);
                    // getChallengeImage(data.Matches[tc].id_challenge);
                    // getResult(data.Matches[tc].id_challenge);
                    getChallengeID(data.Matches[tc].id);
                });

        }

        function getChallengeID(matchID) {
            fetch(url + `match/` + matchID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => {
                    getChallenge(data.id_challenge);
                    getChallengeImage(data.id_challenge);
                })
        }

        function getResult(challengeID) {
            fetch(url + `solution/team/` + challengeID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    // getChallengeID(data.Matches[tc].id);
                });
        }

        function getChallenge(challengeID) {
            fetch(url + `challenge/raw/` + challengeID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "text/plain"
                },
            })
                .then(response => response.text())
                .then(data => { console.log(data) })
        }

        function getChallengeImage(challengeID) {
            fetch(url + `challenge/image/` + challengeID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => { showImage(data); getChallengeScore(challengeID) })
        }

        function getChallengeScore(challengeID) {
            fetch(url + `solution/team/` + 9, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NSwiaWF0IjoxNjQyOTE4OTc1LCJleHAiOjE2NDI5MzY5NzV9.1uChjvoZWwPsU2VHaXiPjvUdDqZ3ScZB89qBlscxxkg',
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => { console.log(data) })
        }

        function showImage(data) {
            var list = document.getElementById("image");

            while (list.hasChildNodes()) {
                list.removeChild(list.firstChild);
            }

            data.forEach(e => {
                var image = new Image();
                image.src = 'data:image/jpeg;base64,' + e;
                list.appendChild(image);

            });
        }

        function submitResult(challengeID) {
            fetch(url + `solution/submit/` + challengeID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "text/plan"
                },
            })
                .then(response => response.json())
                .then(data => {
                    getChallenge(data.id_challenge);
                    getChallengeImage(data.id_challenge);
                })
        }
    </script>
</body>

</html>