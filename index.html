<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Procon 2021</title>
    <style>
        form>* {
            display: block;
            margin: 5px;
        }

        .result>* {
            display: block;
            margin: 5px;
        }
    </style>
</head>

<body>
    <form id="action-form">
        <label for="token">token</label>
        <input type="text" name="token" id="token">
        <label for="token">Test_case:</label>
        <input type="number" name="Test_case" id="Test_case">
        <label for="matchID">matchID</label>
        <button>run</button>
        <input type="button" id="submit" value="submit" onclick="submitResult()" disabled>
    </form>
    <div id="image">

    </div>

    <script>
        let token, tc = 0, n, m, limitSelection, challengeID, soLuongHinh;
        let reload = false;
        const url = 'http://112.137.129.202:8006/';
        const form = document.getElementById("action-form")
        form.addEventListener("submit", (e) => {
            e.preventDefault()
            document.getElementsByTagName("input")[2].removeAttribute("disabled");
            token = document.getElementById("token").value.trim()
            tc = document.getElementById("Test_case").value || 0;

            fetch(url + `tournament/`, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json",
                },
            })
                .then(response => response.json())
                .then(data => { getRound(data[0].id); });

        })

        function getRound(tournamentID) {
            fetch(url + `tournament/` + tournamentID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => { getMatch(data.Rounds[0].id) });
        }

        function getMatch(roundID) {
            fetch(url + `round/` + roundID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => {
                    getChallengeID(data.Matches[tc].id);
                });

        }

        function getChallengeID(matchID) {
            fetch(url + `match/` + matchID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => {
                    challengeID = data.id_challenge;
                    getChallenge(data.id_challenge);
                    getChallengeImage(data.id_challenge);
                })
        }

        function getChallenge(challengeID) {
            fetch(url + `challenge/raw/` + challengeID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "text/plain"
                },
            })
                .then(response => response.text())
                .then(data => {
                    let a = (data.split('\n'));
                    let s = formatString(a[1]);
                    n = Number.parseInt(s.charAt(0)); m = Number.parseInt(s.charAt(2));
                    soLuongHinh = n * m;
                    s = formatString(a[2]);
                    limitSelection = Number.parseInt(s);
                    // submitResult(challengeID);
                })
        }

        function formatString(str) {
            str = str.replace("# ", "");
            return str;
        }

        function submitResult() {
            // console.log(n, m, " ", limitSelection);
            let s = dapAn.mangXoay() + "\n" + dapAn.lineDiChuyen();
            console.log(s);
            fetch(url + `solution/submit/` + challengeID, {
                method: "POST",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "text/plain"
                },
                body: s,
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                })
        }


        function getChallengeImage(challengeID) {
            fetch(url + `challenge/image/` + challengeID, {
                method: "GET",
                headers: {
                    "Authorization": 'Bearer ' + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => response.json())
                .then(data => {
                    showImage(data);
                })
        }

        function showImage(data) {
            var list = document.getElementById("image");

            while (list.hasChildNodes()) {
                list.removeChild(list.firstChild);
            }

            data.forEach(e => {
                var image = new Image();
                image.src = 'data:image/jpeg;base64,' + e;
                list.appendChild(image);

            });
        }

        class line {
            x = Math.floor(Math.random() * n).toString(16);
            y = Math.floor(Math.random() * m).toString(16);
            soBuocDiChuyen = Math.min(Math.floor(Math.random() * 10) + 5, n * m);
            mangDiChuyen = function () {
                var s = '';
                for (var i = 0; i < this.soBuocDiChuyen; i++) {
                    var temp = Math.floor(Math.random() * 4);
                    if (temp == 0) s = s + "L";
                    if (temp == 1) s = s + "U";
                    if (temp == 2) s = s + "D";
                    if (temp == 3) s = s + "R";
                }
                return s;
            };

        };
        var dapAn = {
            mangXoay: function () {
                for (var i = 0; i < soLuongHinh; i++)
                    dapAn.mangXoay[i] = Math.floor(Math.random() * 4);
                var s = '';
                for (var i = 0; i < soLuongHinh; i++) s = s + dapAn.mangXoay[i];
                return s;
            },
            soLine: Math.floor(Math.random() * 5) + 3,
            lineDiChuyen: function () {
                var l = [];
                let result = this.soLine + "\n";
                for (var i = 0; i < this.soLine; i++) {
                    l[i] = new line();
                    result += l[i].x + "" + l[i].y + "\n" + l[i].soBuocDiChuyen + "\n" + l[i].mangDiChuyen() + "\n";
                }
                return result;
            }

        };

    </script>
</body>

</html>


<!-- function getChallengeScore(challengeID) {
    fetch(url + `solution/team/` + challengeID, {
        method: "GET",
        headers: {
            "Authorization": 'Bearer ' + token,
            "Content-Type": "application/json"
        },
    })
        .then(response => response.json())
        .then(data => { console.log(data) })
} -->
<!-- function getResult(challengeID) {
    fetch(url + `solution/team/` + challengeID, {
        method: "GET",
        headers: {
            "Authorization": 'Bearer ' + token,
            "Content-Type": "application/json"
        },
    })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            // getChallengeID(data.Matches[tc].id);
        });
} -->